input {
  tcp {
    port => 5044
    codec => json_lines
  }

  http {
    port => 8080
    codec => json
  }
}

filter {
  # Add timestamp if not present
  if ![timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Add service name based on source
  if [docker][container][name] {
    mutate {
      add_field => { "service" => "%{[docker][container][name]}" }
    }
  }

  # Parse log levels
  grok {
    match => { "message" => "%{LOGLEVEL:level} %{DATA:logger} %{GREEDYDATA:message}" }
    overwrite => [ "message" ]
  }

  # Extract metrics from Prometheus format
  if [message] =~ /^# / {
    drop {}
  }

  # Parse Python log format
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:module} %{GREEDYDATA:message}" }
    overwrite => [ "message" ]
  }

  # Add geoip information for IP addresses
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Parse API request logs
  if [request] {
    grok {
      match => { "request" => "%{WORD:http_method} %{URIPATHPARAM:request_path} %{WORD:http_version}" }
    }

    # Extract query parameters
    if [request_path] =~ /\?/ {
      grok {
        match => { "request_path" => "%{URIPATH:path}\?%{GREEDYDATA:query_string}" }
      }
    }
  }

  # Parse forecast metrics
  if [metric_name] =~ /^forecast/ {
    mutate {
      add_tag => "forecast"
    }
  }

  # Parse GPU metrics
  if [metric_name] =~ /gpu|cuda/ {
    mutate {
      add_tag => "gpu"
    }
  }

  # Parse error logs
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => "error"
    }
  }

  # Parse performance metrics
  if [response_time] {
    mutate {
      convert => { "response_time" => "float" }
    }
  }

  # Add environment information
  mutate {
    add_field => { "environment" => "production" }
    add_field => { "application" => "AGENTIC_FORECAST" }
  }
}

output {
  # Main Elasticsearch output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "agentic-forecast-%{+YYYY.MM.dd}"
    document_type => "_doc"

    # Template configuration
    template => "/usr/share/logstash/config/elasticsearch-template.json"
    template_name => "agentic-forecast"
    template_overwrite => true
  }

  # Error logs to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "agentic-forecast-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }

  # GPU logs to separate index
  if "gpu" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "agentic-forecast-gpu-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }

  # Debug output (can be removed in production)
  stdout {
    codec => rubydebug
  }
}
